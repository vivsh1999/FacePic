# Database Schema Documentation

The application uses **MongoDB** (database name: `imagetag`) with three primary collections: `images`, `persons`, and `faces`.

## 1. Images Collection (`images`)
Stores metadata for every photo uploaded or imported into the system.

| Field | Type | Description |
| :--- | :--- | :--- |
| `_id` | ObjectId | Unique identifier for the image document. |
| `filename` | String | UUID-based filename used as the key in Cloudflare R2 (e.g., `a1b2c3d4...jpg`). |
| `original_filename` | String | The original name of the file on the user's local disk. |
| `filepath` | String | Redundant field, currently same as `filename`. |
| `thumbnail_path` | String | R2 key for the generated thumbnail (e.g., `thumb_a1b2...jpg`). |
| `width` | Integer | Image width in pixels. |
| `height` | Integer | Image height in pixels. |
| `file_size` | Integer | Size of the file in bytes. |
| `mime_type` | String | MIME type of the file (e.g., `image/jpeg`). |
| `processed` | Boolean | `True` indicates face detection has been completed. |
| `uploaded_at` | Date | Timestamp when the image was imported. |
| `processed_at` | Date | Timestamp when the processing script finished. |
| `folder_id` | ObjectId | Reference to the **Folder** document where this image resides. |

## 2. Folders Collection (`folders`)
Represents the directory structure of the imported images.

| Field | Type | Description |
| :--- | :--- | :--- |
| `_id` | ObjectId | Unique identifier for the folder. |
| `name` | String | Name of the folder (e.g., "Vacation 2023"). |
| `parent_id` | ObjectId | Reference to the parent folder (null for root folders). |
| `path` | String | Materialized path for easier querying (e.g., "/Vacations/2023"). |
| `created_at` | Date | Timestamp when the folder was created. |
| `updated_at` | Date | Timestamp of the last update. |

## 3. Persons Collection (`persons`)
Represents a unique identity. A "Person" is essentially a cluster of similar faces.

| Field | Type | Description |
| :--- | :--- | :--- |
| `_id` | ObjectId | Unique identifier for the person. |
| `name` | String | User-assigned name. Defaults to `null` until manually labeled. |
| `created_at` | Date | Timestamp when this person was first identified. |
| `updated_at` | Date | Timestamp of the last update to this record. |

## 3. Faces Collection (`faces`)
Stores individual faces detected within the images. This collection links Images to Persons.

| Field | Type | Description |
| :--- | :--- | :--- |
| `_id` | ObjectId | Unique identifier for the face detection. |
| `image_id` | ObjectId | Reference to the parent **Image** document. |
| `person_id` | String | Reference to the matched **Person** document. |
| `encoding` | Array\<Float\> | 512-dimensional vector representing the face features (generated by InsightFace). |
| `location` | Object | Bounding box coordinates: `{ top, right, bottom, left }`. |
| `created_at` | Date | Timestamp when the face was detected. |

## Relationships

- **One Image** can contain **Many Faces**.
- **One Person** is associated with **Many Faces** (across different images).
- **Faces** act as the join table between **Images** and **Persons**, containing the biometric data (`encoding`) used for clustering.

## Indexing Strategy (Current)
- The Python script currently performs a linear scan or fetches all faces for a person to calculate Cosine Similarity in memory.
- **Future Optimization**: The `encoding` field is suitable for **MongoDB Atlas Vector Search** to enable scalable similarity search without loading all vectors into application memory.
